#!/bin/bash
# configure script adapter for cmake
# Copyright 2010, 2011, 2013 Colin Walters <walters@verbum.org>
# Licensed under the new-BSD license (http://www.opensource.org/licenses/bsd-license.php)

prefix=/usr

# Little helper function for reading args from the commandline.
# it automatically handles -a b and -a=b variants, and returns 1 if
# we need to shift $3.
read_arg() {
    # $1 = arg name
    # $2 = arg value
    # $3 = arg parameter
    local rematch='^[^=]*=(.*)$'
    if [[ $2 =~ $rematch ]]; then
        read "$1" <<< "${BASH_REMATCH[1]}"
    else
        read "$1" <<< "$3"
        # There is no way to shift our callers args, so
        # return 1 to indicate they should do it instead.
        return 1
    fi
}

disable_documentation=false
enable_shared=false

while (($# > 0)); do
    case "${1%%=*}" in
        --prefix) read_arg prefix "$@" || shift;;
        --bindir) read_arg bindir "$@" || shift;;
        --sbindir) read_arg sbindir "$@" || shift;;
        --libexecdir) read_arg libexecdir "$@" || shift;;
        --datarootdir) read_arg datarootdir "$@" || shift;;
        --datadir) read_arg datadir "$@" || shift;;
        --sysconfdir) read_arg sysconfdir "$@" || shift;;
        --libdir) read_arg libdir "$@" || shift;;
        --mandir) read_arg mandir "$@" || shift;;
        --disable-documentation)  disable_documentation=true ;;
        --enable-shared)  enable_shared=true ;;
        *) echo "Ignoring unknown option '$1'";;
    esac
    shift
done

bindir=${bindir:-$prefix/bin}
libdir=${libdir:-$prefix/lib}

srcdir=$(dirname $0)

opts=
$disable_documentation && opts="$opts -DJANSSON_BUILD_DOCS=OFF"
$enable_shared && opts="$opts -DJANSSON_BUILD_SHARED_LIBS=ON"

cmake \
     "-DCMAKE_INSTALL_PREFIX:PATH=$prefix" \
     "-DJANSSON_INSTALL_LIB_DIR:PATH=$libdir" \
     "-DJANSSON_INSTALL_BIN_DIR:PATH=$bindir" \
     "-DJANSSON_INSTALL_INCLUDE_DIR:PATH=$prefix/include" \
     "-DJANSSON_INSTALL_CMAKE_DIR:PATH=$libdir/cmake" \
     $opts \
     ${srcdir}
